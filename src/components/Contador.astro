---
// =============================================================================
// ContadorSection.astro - Sección de Contador con partículas de estrellas
// =============================================================================

const config = {
  imagenFondo: "/imagenes/fondo3.webp",
  textoDecorativo: "Solo Faltan",
  fechaEvento: "2025-12-28T17:00:00",
  altImagen: "Fondo elegante para contador",
  etiquetas: {
    dias: "DÍAS",
    horas: "HORAS",
    minutos: "MINUTOS",
    segundos: "SEGUNDOS"
  }
};
---

<section 
  class="relative w-full h-screen flex items-center justify-center overflow-hidden"
  aria-label="Contador regresivo"
  id="contador-section"
>
  
  <!-- ✨ FONDO CON EFECTO ELEGANTE DE RESPIRACIÓN ✨ -->
  <div class="hero-bg absolute inset-0 z-0 opacity-0">
    <img 
      src={config.imagenFondo}
      alt={config.altImagen}
      class="w-full h-full object-cover"
      loading="lazy"
    />
    <!-- Overlay idéntico -->
    <div class="absolute inset-0 bg-black/40"></div>
  </div>

  <!-- ========================================
    CANVAS PARA PARTÍCULAS DE ESTRELLAS
  ======================================== -->
  <canvas 
    id="contador-stars-canvas" 
    class="absolute inset-0 pointer-events-none opacity-0"
    style="z-index: 5;"
  ></canvas>

  <!-- CONTENIDO DEL CONTADOR (centrado, sobre el fondo) -->
  <div class="relative z-10 w-full max-w-md mx-auto px-6 text-center">
    
    <h2 
      class="font-great-vibes text-4xl md:text-5xl lg:text-6xl text-white mb-8 drop-shadow-lg opacity-0"
      style="transform: translateY(30px);"
      id="texto-decorativo"
    >
      {config.textoDecorativo}
    </h2>

    <div 
      class="contador-grid grid grid-cols-4 gap-3 md:gap-4 opacity-0"
      style="transform: translateY(40px);"
      id="contador-grid"
    >
      <!-- DÍAS -->
      <div class="contador-item">
        <div class="bg-white/10 backdrop-blur-md rounded-lg p-4 md:p-5 border border-white/20 shadow-xl">
          <div class="text-4xl md:text-5xl font-bold text-white mb-2 font-charm" id="dias">00</div>
          <div class="text-xs md:text-sm text-white/90 font-medium tracking-wider font-charm">{config.etiquetas.dias}</div>
        </div>
      </div>

      <!-- HORAS -->
      <div class="contador-item">
        <div class="bg-white/10 backdrop-blur-md rounded-lg p-4 md:p-5 border border-white/20 shadow-xl">
          <div class="text-4xl md:text-5xl font-bold text-white mb-2 font-charm" id="horas">00</div>
          <div class="text-xs md:text-sm text-white/90 font-medium tracking-wider font-charm">{config.etiquetas.horas}</div>
        </div>
      </div>

      <!-- MINUTOS -->
      <div class="contador-item">
        <div class="bg-white/10 backdrop-blur-md rounded-lg p-4 md:p-5 border border-white/20 shadow-xl">
          <div class="text-4xl md:text-5xl font-bold text-white mb-2 font-charm" id="minutos">00</div>
          <div class="text-xs md:text-sm text-white/90 font-medium tracking-wider font-charm">{config.etiquetas.minutos}</div>
        </div>
      </div>

      <!-- SEGUNDOS -->
      <div class="contador-item">
        <div class="bg-white/10 backdrop-blur-md rounded-lg p-4 md:p-5 border border-white/20 shadow-xl">
          <div class="text-4xl md:text-5xl font-bold text-white mb-2 font-charm" id="segundos">00</div>
          <div class="text-xs md:text-sm text-white/90 font-medium tracking-wider font-charm">{config.etiquetas.segundos}</div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Efecto de pulso en números */
  @keyframes pulse-number {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  #dias, #horas, #minutos, #segundos {
    animation: pulse-number 1s ease-in-out infinite;
  }

  /* Sombras para mejor contraste */
  .contador-item {
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
  }

  @media (max-width: 640px) {
    .contador-item {
      font-size: 0.9rem;
    }
  }
</style>

<!-- ✅ SCRIPT CON PARTÍCULAS DE ESTRELLAS -->
<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  document.addEventListener('DOMContentLoaded', () => {
    const section = document.getElementById('contador-section');
    const heroImage = section?.querySelector('.hero-bg img');
    const heroBg = section?.querySelector('.hero-bg');
    const canvas = document.getElementById('contador-stars-canvas');

    if (!heroImage || !heroBg || !section || !canvas) return;

    // =========================================================
    // SISTEMA DE PARTÍCULAS - ESTRELLAS VOLANDO
    // =========================================================
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animationFrameId = null;

    // Ajustar tamaño del canvas
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Clase Partícula (Estrella)
    class Star {
      constructor() {
        this.reset();
        this.y = Math.random() * canvas.height;
      }

      reset() {
        this.x = Math.random() * canvas.width;
        this.y = -10;
        this.size = Math.random() * 3 + 1;
        this.speedY = Math.random() * 1.5 + 0.5;
        this.speedX = (Math.random() - 0.5) * 0.5;
        this.opacity = Math.random() * 0.5 + 0.3;
        this.twinkle = Math.random() * 0.05;
      }

      update() {
        this.y += this.speedY;
        this.x += this.speedX;
        this.opacity += this.twinkle;
        
        if (this.opacity >= 1 || this.opacity <= 0.3) {
          this.twinkle *= -1;
        }

        if (this.y > canvas.height) {
          this.reset();
        }
      }

      draw() {
        ctx.save();
        ctx.globalAlpha = this.opacity;
        ctx.fillStyle = '#FFD700';
        
        // Dibujar estrella de 5 puntas
        ctx.beginPath();
        for (let i = 0; i < 5; i++) {
          const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
          const x = this.x + Math.cos(angle) * this.size;
          const y = this.y + Math.sin(angle) * this.size;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.fill();

        // Brillo alrededor de la estrella
        const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size * 2);
        gradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
        gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size * 2, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.restore();
      }
    }

    // Crear partículas
    function createParticles() {
      const particleCount = 50;
      particles = [];
      for (let i = 0; i < particleCount; i++) {
        particles.push(new Star());
      }
    }

    // Animar partículas
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      particles.forEach(particle => {
        particle.update();
        particle.draw();
      });

      animationFrameId = requestAnimationFrame(animateParticles);
    }

    // Detener animación
    function stopParticles() {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
    }

    // =========================================================
    // ANIMACIÓN INICIAL - ENTRADA DRAMÁTICA
    // =========================================================
    const tl = gsap.timeline({ 
      defaults: { 
        ease: 'power3.out' 
      },
      scrollTrigger: {
        trigger: section,
        start: 'top 80%',
        toggleActions: 'play none none none'
      }
    });

    // Fade in del fondo
    tl.to(heroBg, {
      opacity: 1,
      duration: 1.5,
      ease: 'power2.out'
    }, 0);

    // Zoom inicial dramático (de grande a normal)
    tl.fromTo(heroImage,
      { scale: 1.3 },
      { 
        scale: 1.05,
        duration: 2.5, 
        ease: 'power2.out',
        onComplete: () => {
          // Efecto de respiración continuo
          gsap.to(heroImage, {
            scale: 1.08,
            duration: 4,
            ease: 'sine.inOut',
            yoyo: true,
            repeat: -1
          });
        }
      }
    , 0);

    // Animación del texto decorativo
    tl.to('#texto-decorativo', {
      y: 0,
      opacity: 1,
      scale: 1,
      duration: 1.5,
      ease: 'power4.out'
    }, 0.5);

    // Animación del grid del contador
    tl.to('#contador-grid', {
      y: 0,
      opacity: 1,
      scale: 1,
      duration: 1.2,
      ease: 'back.out(1.2)'
    }, 0.8);

    // Activar partículas cuando la sección esté visible
    ScrollTrigger.create({
      trigger: section,
      start: 'top bottom',
      end: 'bottom top',
      onEnter: () => {
        gsap.to(canvas, {
          opacity: 1,
          duration: 1.5,
          ease: 'power2.out'
        });
        if (!animationFrameId) {
          createParticles();
          animateParticles();
        }
      },
      onLeave: () => {
        gsap.to(canvas, {
          opacity: 0,
          duration: 0.8,
          onComplete: stopParticles
        });
      },
      onEnterBack: () => {
        gsap.to(canvas, {
          opacity: 1,
          duration: 1.5
        });
        if (!animationFrameId) {
          createParticles();
          animateParticles();
        }
      },
      onLeaveBack: () => {
        gsap.to(canvas, {
          opacity: 0,
          duration: 0.8,
          onComplete: stopParticles
        });
      }
    });

    // =========================================================
    // CONTADOR REGRESIVO - 28 de Diciembre 2025, 17:00
    // =========================================================
    const fechaEvento = new Date("2025-12-28T17:00:00").getTime();

    function actualizarContador() {
      const ahora = new Date().getTime();
      const diferencia = fechaEvento - ahora;

      if (diferencia > 0) {
        const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
        const horas = Math.floor((diferencia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
        const segundos = Math.floor((diferencia % (1000 * 60)) / 1000);

        const update = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = String(value).padStart(2, "0");
        };

        update("dias", dias);
        update("horas", horas);
        update("minutos", minutos);
        update("segundos", segundos);
      } else {
        ["dias", "horas", "minutos", "segundos"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = "00";
        });
      }
    }

    actualizarContador();
    setInterval(actualizarContador, 1000);
  });
</script>